<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CalcuSim仿真 &mdash; Maptools 1.0 文档</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/logo.png"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="TokSim仿真" href="TokSim%E4%BB%BF%E7%9C%9F.html" />
    <link rel="prev" title="映射前仿真" href="%E6%98%A0%E5%B0%84%E5%89%8D%E4%BB%BF%E7%9C%9F.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Maptools
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">Maptools 安装与配置</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Maptools%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/%E5%AE%89%E8%A3%85%E7%8E%AF%E5%A2%83%E4%BB%8B%E7%BB%8D.html">安装环境介绍</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Maptools%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/%E5%AE%89%E8%A3%85%E7%8E%AF%E5%A2%83%E4%BB%8B%E7%BB%8D.html#id2">系统环境</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Maptools%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/%E5%AE%89%E8%A3%85%E7%8E%AF%E5%A2%83%E4%BB%8B%E7%BB%8D.html#python">Python</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Maptools%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%E5%BA%93.html">安装依赖库</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Maptools%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%E5%BA%93.html#python">安装python依赖库</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Maptools%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%E5%BA%93.html#pytorch">安装pytorch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Maptools%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%E5%BA%93.html#graphviz">安装Graphviz</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%E5%BA%93.html#windowsgraphviz">在Windows中安装Graphviz</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%E5%BA%93.html#linux-wslgraphviz">在Linux/WSL中安装Graphviz</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Maptools%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/%E5%AE%89%E8%A3%85Maptools.html">安装 Maptools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Maptools%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/%E5%AE%89%E8%A3%85Maptools.html#windows-name">在Windows中安装 Maptools</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Maptools%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/%E5%AE%89%E8%A3%85Maptools.html#linux-wsl-name">在Linux/WSL中安装 Maptools</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Maptools%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F.html">配置环境变量</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Maptools%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F.html#cmd">配置cmd环境变量</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Maptools%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F.html#powershell">配置Powershell环境变量</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Maptools%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F.html#linux-wsl">配置Linux/WSL环境变量</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">使用 Maptools 执行模型映射</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E5%87%86%E5%A4%87%E4%BD%A0%E7%9A%84AI%E6%A8%A1%E5%9E%8B.html">准备你的AI模型</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E5%87%86%E5%A4%87%E4%BD%A0%E7%9A%84AI%E6%A8%A1%E5%9E%8B.html#onnx">获取onnx模型</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E5%87%86%E5%A4%87%E4%BD%A0%E7%9A%84AI%E6%A8%A1%E5%9E%8B.html#id1">通过云盘获得onnx模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E5%87%86%E5%A4%87%E4%BD%A0%E7%9A%84AI%E6%A8%A1%E5%9E%8B.html#id3">自己动手导出onnx模型</a></li>
<li class="toctree-l3"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E5%87%86%E5%A4%87%E4%BD%A0%E7%9A%84AI%E6%A8%A1%E5%9E%8B.html#githubonnx">从github上获取onnx模型</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E5%87%86%E5%A4%87%E4%BD%A0%E7%9A%84AI%E6%A8%A1%E5%9E%8B.html#netron-check">查看onnx模型</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E9%85%8D%E7%BD%AE%E5%85%A8%E5%B1%80%E5%8F%82%E6%95%B0.html">配置全局参数</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E9%85%8D%E7%BD%AE%E5%85%A8%E5%B1%80%E5%8F%82%E6%95%B0.html#id2">全局参数介绍</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E9%85%8D%E7%BD%AE%E5%85%A8%E5%B1%80%E5%8F%82%E6%95%B0.html#mapname"><code class="docutils literal notranslate"><span class="pre">mapname</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E9%85%8D%E7%BD%AE%E5%85%A8%E5%B1%80%E5%8F%82%E6%95%B0.html#quantize"><code class="docutils literal notranslate"><span class="pre">quantize</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E9%85%8D%E7%BD%AE%E5%85%A8%E5%B1%80%E5%8F%82%E6%95%B0.html#id3">推荐的参数配置方法</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E9%87%8F%E5%8C%96.html">执行模型量化</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E9%87%8F%E5%8C%96.html#id2">随机校准量化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E9%87%8F%E5%8C%96.html#id3">专用数据集校准量化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E9%87%8F%E5%8C%96.html#id4">模型量化结果说明</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E8%BD%AC%E6%8D%A2.html">执行模型转换</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E8%BD%AC%E6%8D%A2.html#id2">模型转换流程介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E8%BD%AC%E6%8D%A2.html#onnxconverter">通过 <code class="xref py py-data docutils literal notranslate"><span class="pre">OnnxConverter</span></code> 实现模型转换</a></li>
<li class="toctree-l2"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E8%BD%AC%E6%8D%A2.html#id3">模型转换结果说明</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E6%89%A7%E8%A1%8CTile%E6%98%A0%E5%B0%84%20%28%E9%80%BB%E8%BE%91%E6%98%A0%E5%B0%84%29.html">执行Tile映射 (逻辑映射)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E6%89%A7%E8%A1%8CTile%E6%98%A0%E5%B0%84%20%28%E9%80%BB%E8%BE%91%E6%98%A0%E5%B0%84%29.html#tilemapper-tile">通过 <code class="xref py py-data docutils literal notranslate"><span class="pre">TileMapper</span></code> 实现Tile映射</a></li>
<li class="toctree-l2"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E6%89%A7%E8%A1%8CTile%E6%98%A0%E5%B0%84%20%28%E9%80%BB%E8%BE%91%E6%98%A0%E5%B0%84%29.html#id1">Tile映射结果说明</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E6%89%A7%E8%A1%8CNoC%E6%98%A0%E5%B0%84%20%28%E7%89%A9%E7%90%86%E6%98%A0%E5%B0%84%29.html">执行NoC映射 (物理映射)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E6%89%A7%E8%A1%8CNoC%E6%98%A0%E5%B0%84%20%28%E7%89%A9%E7%90%86%E6%98%A0%E5%B0%84%29.html#id1">NoC映射流程介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E6%89%A7%E8%A1%8CNoC%E6%98%A0%E5%B0%84%20%28%E7%89%A9%E7%90%86%E6%98%A0%E5%B0%84%29.html#nocmapper-noc">通过 <code class="xref py py-data docutils literal notranslate"><span class="pre">NocMapper</span></code> 实现NoC映射</a></li>
<li class="toctree-l2"><a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E6%89%A7%E8%A1%8CNoC%E6%98%A0%E5%B0%84%20%28%E7%89%A9%E7%90%86%E6%98%A0%E5%B0%84%29.html#id2">NoC映射结果说明</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">使用 Maptools 执行系统仿真</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="%E6%98%A0%E5%B0%84%E5%89%8D%E4%BB%BF%E7%9C%9F.html">映射前仿真</a><ul>
<li class="toctree-l2"><a class="reference internal" href="%E6%98%A0%E5%B0%84%E5%89%8D%E4%BB%BF%E7%9C%9F.html#id2">什么是映射前仿真?</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E6%98%A0%E5%B0%84%E5%89%8D%E4%BB%BF%E7%9C%9F.html#modeltask">通过 <code class="xref py py-data docutils literal notranslate"><span class="pre">ModelTask</span></code> 实现映射前仿真</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E6%98%A0%E5%B0%84%E5%89%8D%E4%BB%BF%E7%9C%9F.html#id3">仿真结果验证</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">CalcuSim仿真</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">什么是 <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 仿真?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2"><code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 的组织结构</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">单张图片的 <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 仿真</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id4">量化前仿真</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">量化后仿真</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#mac">MAC结果范围统计</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ivc">根据统计结果设置IVC系数</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">执行仿真</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id7">中间结果观测</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id8">中间结果保存</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id9">中间结果读取</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id10">使用测试集实现准确率评估</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="TokSim%E4%BB%BF%E7%9C%9F.html">TokSim仿真</a><ul>
<li class="toctree-l2"><a class="reference internal" href="TokSim%E4%BB%BF%E7%9C%9F.html#id1">什么是 <code class="xref py py-data docutils literal notranslate"><span class="pre">TokSim</span></code> 仿真?</a></li>
<li class="toctree-l2"><a class="reference internal" href="TokSim%E4%BB%BF%E7%9C%9F.html#id2"><code class="xref py py-data docutils literal notranslate"><span class="pre">TokSim</span></code> 的组织结构</a></li>
<li class="toctree-l2"><a class="reference internal" href="TokSim%E4%BB%BF%E7%9C%9F.html#id3">使用 <code class="xref py py-data docutils literal notranslate"><span class="pre">TokSim</span></code> 进行缓存容量评估</a></li>
<li class="toctree-l2"><a class="reference internal" href="TokSim%E4%BB%BF%E7%9C%9F.html#id4">使用 <code class="xref py py-data docutils literal notranslate"><span class="pre">TokSim</span></code> 进行通信负载分布评估</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Maptools 源代码结构</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html">core</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#id1">数据类型</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#LogicalTile"><code class="docutils literal notranslate"><span class="pre">LogicalTile</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#PhysicalTile"><code class="docutils literal notranslate"><span class="pre">PhysicalTile</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#ArbitaryEdge"><code class="docutils literal notranslate"><span class="pre">ArbitaryEdge</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#MeshEdge"><code class="docutils literal notranslate"><span class="pre">MeshEdge</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#NNModelArch"><code class="docutils literal notranslate"><span class="pre">NNModelArch</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#NNModelArch.VGG"><code class="docutils literal notranslate"><span class="pre">NNModelArch.VGG</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#NNModelArch.RESNET"><code class="docutils literal notranslate"><span class="pre">NNModelArch.RESNET</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#NNModelArch.GOOGLENET"><code class="docutils literal notranslate"><span class="pre">NNModelArch.GOOGLENET</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#NNModelArch.YOLO_V3"><code class="docutils literal notranslate"><span class="pre">NNModelArch.YOLO_V3</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#NNModelArch.SQUEEZENET"><code class="docutils literal notranslate"><span class="pre">NNModelArch.SQUEEZENET</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#DLEMethod"><code class="docutils literal notranslate"><span class="pre">DLEMethod</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#DLEMethod.REVERSE_S"><code class="docutils literal notranslate"><span class="pre">DLEMethod.REVERSE_S</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#DREMethod"><code class="docutils literal notranslate"><span class="pre">DREMethod</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#DREMethod.DyXY"><code class="docutils literal notranslate"><span class="pre">DREMethod.DyXY</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#DREMethod.RPM"><code class="docutils literal notranslate"><span class="pre">DREMethod.RPM</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#DREMethod.OCR"><code class="docutils literal notranslate"><span class="pre">DREMethod.OCR</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#id2">数据结构</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#OperatorConfig"><code class="docutils literal notranslate"><span class="pre">OperatorConfig</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#TileConfig"><code class="docutils literal notranslate"><span class="pre">TileConfig</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#ModelParams"><code class="docutils literal notranslate"><span class="pre">ModelParams</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#OperatorQuantConfig"><code class="docutils literal notranslate"><span class="pre">OperatorQuantConfig</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#TileQuantConfig"><code class="docutils literal notranslate"><span class="pre">TileQuantConfig</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#id3">中间级表示</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#OperatorGraph"><code class="docutils literal notranslate"><span class="pre">OperatorGraph</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#OriginGraph"><code class="docutils literal notranslate"><span class="pre">OriginGraph</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#HostGraph"><code class="docutils literal notranslate"><span class="pre">HostGraph</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#DeviceGraph"><code class="docutils literal notranslate"><span class="pre">DeviceGraph</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#CTG"><code class="docutils literal notranslate"><span class="pre">CTG</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#ACG"><code class="docutils literal notranslate"><span class="pre">ACG</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/quantization.html">quantization</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/quantization.html#quantize"><code class="docutils literal notranslate"><span class="pre">quantize()</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/mapper.html">mapper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/nlrt.html">nlrt</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/nlrt.html#id2">布局</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/nlrt.html#id3">布局设计工具</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/nlrt.html#layout-engine">布局引擎</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/nlrt.html#id5">布局编码</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/nlrt.html#id6">布局结果</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/nlrt.html#id7">布线</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/nlrt.html#id8">布线设计工具</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/nlrt.html#routing-engine">布线引擎</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/nlrt.html#id10">布线编码</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/nlrt.html#id11">布线结果</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/nlrt.html#id12">智能优化算法</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/calcusim.html">calcusim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/toksim.html">toksim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/drawing.html">drawing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Maptools</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">CalcuSim仿真</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/使用Maptools执行系统仿真/CalcuSim仿真.rst.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="calcusim">
<h1>CalcuSim仿真<a class="headerlink" href="#calcusim" title="此标题的永久链接"></a></h1>
<section id="id1">
<h2>什么是 <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 仿真?<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h2>
<p><code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 是一款面向存算一体AI芯片的准确率仿真工具.
它根据 <a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#CTG" title="CTG"><code class="xref py py-data docutils literal notranslate"><span class="pre">CTG</span></code></a> 中每个 Tile 的配置信息构建出存算一体中的硬件计算模型, 能够实现对硬件中每个 Tile 计算过程的模拟以及中间计算结果的观测, 从而实现对实际存算一体AI芯片识别准确率的精确评估. 另外, 用户可以调节 <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 的硬件参数, 以实现不同硬件配置模式下的准确率评估.</p>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>Maptools 针对 Tile 内部硬件的实际计算特性 (如逐 bit 输入 (Bit Serial),  ADC 箝位 (Clamp) 等, 量化转换, 乘法解构等)  进行了软件模拟,
并为用户注入器件非理想因素 (比如 IVC 系数 (电流-电压转换系数),  ADC 量化误差以及 Xbar 权重漂移等) 提供了可扩展接口, 从而能够实现对整个硬件计算过程的精确模拟.</p>
</div>
</section>
<section id="id2">
<h2><code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 的组织结构<a class="headerlink" href="#id2" title="此标题的永久链接"></a></h2>
<p><code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 由 <code class="xref py py-data docutils literal notranslate"><span class="pre">DeviceTask</span></code> (设备任务执行器) 和 <code class="xref py py-data docutils literal notranslate"><span class="pre">HostTask</span></code> (主机任务执行器) 两部分组成,
其中 <code class="xref py py-data docutils literal notranslate"><span class="pre">DeviceTask</span></code> 是主体, <code class="xref py py-data docutils literal notranslate"><span class="pre">DeviceTask</span></code> 包含多个 <code class="xref py py-data docutils literal notranslate"><span class="pre">TileTask</span></code>, 每个 <code class="xref py py-data docutils literal notranslate"><span class="pre">TileTask</span></code> 内部实现了对Tile 计算过程的模拟,
如下图所示:</p>
<a class="reference internal image-reference" href="../_images/3.svg"><img alt="../_images/3.svg" class="align-center" height="331" src="../_images/3.svg" width="653" /></a>
<br><p><code class="xref py py-data docutils literal notranslate"><span class="pre">ModelTask</span></code> 本质是一个 <code class="xref py py-data docutils literal notranslate"><span class="pre">torch.nn.Module</span></code>, 支持 <cite>cuda</cite> 加速, 用户可以像调用 <code class="xref py py-data docutils literal notranslate"><span class="pre">torch.nn.Module</span></code> 模型那样通过调用 <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim.forward</span></code> 方法实现 <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 仿真, 并通过调用 <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim.cuda</span></code> 方法实现 <cite>cuda</cite> 加速.</p>
</section>
<section id="id3">
<h2>单张图片的 <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 仿真<a class="headerlink" href="#id3" title="此标题的永久链接"></a></h2>
<p><code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 支持量化前仿真和量化后仿真, 用户可以通过在构建 <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 对象时设置对应 <a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E9%85%8D%E7%BD%AE%E5%85%A8%E5%B1%80%E5%8F%82%E6%95%B0.html#quantize" title="quantize"><code class="xref py py-data docutils literal notranslate"><span class="pre">quantize</span></code></a> 参数, 以决定是否开启量化后仿真.</p>
<div class="admonition attention">
<p class="admonition-title">注意</p>
<p><code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 是用来模拟硬件计算的, 那 <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 的量化前仿真有何意义?</p>
<p><code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 的量化前仿真可以用于验证Tile映射的正确性, 因为当Tile映射出现错误时, 所构建出的 <a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#CTG" title="CTG"><code class="xref py py-data docutils literal notranslate"><span class="pre">CTG</span></code></a> 是不正确的, 因此 <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 的仿真结果自然也是错误的.</p>
</div>
<p>在构建 <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 时, 需要传入三个位置参数:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#CTG" title="CTG"><code class="xref py py-data docutils literal notranslate"><span class="pre">CTG</span></code></a>, 可以从 <code class="xref py py-data docutils literal notranslate"><span class="pre">TileMapper.ctg</span></code> 属性获取.</p></li>
<li><p><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#HostGraph" title="HostGraph"><code class="xref py py-data docutils literal notranslate"><span class="pre">HostGraph</span></code></a> 类型的主机算子图, 可以从 <code class="xref py py-data docutils literal notranslate"><span class="pre">OnnxConverter.host_graph</span></code> 属性获取.</p></li>
<li><p><a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#ModelParams" title="ModelParams"><code class="xref py py-data docutils literal notranslate"><span class="pre">ModelParams</span></code></a> 类型的模型参数, 在执行量化前仿真时, 该模型参数可以从 <code class="xref py py-data docutils literal notranslate"><span class="pre">OnnxConverter.params</span></code> 属性获取, 在执行量化后仿真时, 需要使用 Maptools 提供的 <code class="xref py py-data docutils literal notranslate"><span class="pre">read_quantparams</span></code> 从量化保存的 <cite>./mapsave/your-mapname/quantparams.pkl</cite> 中读取量化后的模型参数.</p></li>
</ul>
<p>另外, <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 还接受一些关键字参数, 详见 <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim.__init__</span></code>.</p>
<section id="id4">
<h3>量化前仿真<a class="headerlink" href="#id4" title="此标题的永久链接"></a></h3>
<p>下面展示了一个使用 <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 进行单张图片量化前仿真的示例:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 代码接上回</span>
<span class="o">...</span>

<span class="c1"># 创建CalcuSim仿真器, tm是TileMapper, oc是OnnxConverter</span>
<span class="n">csim</span> <span class="o">=</span> <span class="n">CalcuSim</span><span class="p">(</span><span class="n">tm</span><span class="o">.</span><span class="n">ctg</span><span class="p">,</span> <span class="n">oc</span><span class="o">.</span><span class="n">host_graph</span><span class="p">,</span> <span class="n">oc</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">quantize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># 获取输入图片数据, 缩放至 224 × 224</span>
<span class="nb">input</span> <span class="o">=</span> <span class="n">get_input</span><span class="p">(</span><span class="s1">&#39;path/to/your/image.png&#39;</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">))</span>

<span class="c1"># 运行CalcuSim仿真, 获得输出结果</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">csim</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

<span class="c1"># 仿真结果验证</span>
<span class="o">...</span>
</pre></div>
</div>
</section>
<section id="id5">
<h3>量化后仿真<a class="headerlink" href="#id5" title="此标题的永久链接"></a></h3>
<p>在确定量化前仿真结果无误后, 便可将关键字参数 <a class="reference internal" href="../%E4%BD%BF%E7%94%A8Maptools%E6%89%A7%E8%A1%8C%E6%A8%A1%E5%9E%8B%E6%98%A0%E5%B0%84/%E9%85%8D%E7%BD%AE%E5%85%A8%E5%B1%80%E5%8F%82%E6%95%B0.html#quantize" title="quantize"><code class="xref py py-data docutils literal notranslate"><span class="pre">quantize</span></code></a> 设置为 <cite>True</cite> 以执行量化后仿真. 但是需要注意, 为了模拟实际的Xbar的卷积运算过程, 还需要将关键字参数 <code class="xref py py-data docutils literal notranslate"><span class="pre">physical</span></code> 设置为 <cite>True</cite>, 这一点是非常重要的.</p>
<section id="mac">
<h4>MAC结果范围统计<a class="headerlink" href="#mac" title="此标题的永久链接"></a></h4>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>当 <code class="xref py py-data docutils literal notranslate"><span class="pre">physical</span></code> 设置为 <cite>False</cite> 时, <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 使用Pytorch提供的 <code class="xref py py-data docutils literal notranslate"><span class="pre">torch.nn.functional.conv2d</span></code> 函数实现卷积计算, 但当 <code class="xref py py-data docutils literal notranslate"><span class="pre">physical</span></code> 设置为 <cite>True</cite> 时, <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 使用自定义的 <code class="xref py py-data docutils literal notranslate"><span class="pre">cimu_conv2d</span></code> 函数模拟Xbar的卷积运算过程, 包括ADC的箝位.</p>
<p>ADC箝位意味着在执行量化后仿真时, 不管Xbar的BL (Bitline) 上的MAC (乘累加) 结果的值是多大, 都会将其截断至ADC的量程内, 如果MAC结果比较大, 意味着绝大部分信息都会因为ADC的箝位而丢失, 因此会带来致命性的影响. 合理调整IVC系数可以减少ADC箝位带来的信息损失, IVC系数的效果相当于在将MAC结果乘以一个收缩系数后再输入至ADC, 因此能够尽可能地将MAC结果收缩到ADC的量程内.</p>
<p>ICV系数 (IVCF) 应当设置为多大取决于每个BL上的MAC结果的范围, 如果范围很大, 则IVCF需要设置得比较小.</p>
</div>
<p>问题在于, 在执行量化后仿真之前, 并不知道MAC结果的范围是多少, 为此 <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 提供了MAC结果范围统计的功能, 用户只需要在创建 <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 对象时设置关键字参数 <code class="xref py py-data docutils literal notranslate"><span class="pre">stats</span></code> 为 <cite>True</cite>, 之后运行仿真时会自动禁用ADC箝位并进行MAC结果范围统计, 如下:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 代码接上回</span>
<span class="o">...</span>

<span class="c1"># 获取量化后的模型参数</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">read_quantparams</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;mapname&#39;</span><span class="p">])</span>

<span class="c1"># 创建CalcuSim仿真器, tm是TileMapper, oc是OnnxConverter, 启动MAC结果范围统计</span>
<span class="n">csim</span> <span class="o">=</span> <span class="n">CalcuSim</span><span class="p">(</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">ctg</span><span class="p">,</span> <span class="n">oc</span><span class="o">.</span><span class="n">host_graph</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
    <span class="n">quantize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">physical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># 获取输入图片数据, 缩放至 224 × 224</span>
<span class="nb">input</span> <span class="o">=</span> <span class="n">get_input</span><span class="p">(</span><span class="s1">&#39;path/to/your/image.png&#39;</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">))</span>

<span class="c1"># 运行CalcuSim仿真, 获得输出结果</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">csim</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
</pre></div>
</div>
<p>运行结束后, 会在终端自动打印出MAC结果范围统计报告, 如下:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>--&gt;<span class="w"> </span>Tile<span class="w"> </span><span class="o">(</span><span class="m">15</span>,<span class="w"> </span><span class="m">0</span>,<span class="w"> </span><span class="m">0</span>,<span class="w"> </span><span class="m">0</span><span class="o">)</span>
bit<span class="o">(</span><span class="m">0</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>LSB<span class="o">)</span>:0<span class="w">    </span>range:<span class="w">  </span><span class="o">(</span>-3377,<span class="w"> </span><span class="m">1838</span><span class="o">)</span><span class="w">   </span>avg_abs:<span class="w"> </span><span class="m">639</span>.116
bit<span class="o">(</span><span class="m">0</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>LSB<span class="o">)</span>:1<span class="w">    </span>range:<span class="w">  </span><span class="o">(</span>-2972,<span class="w"> </span><span class="m">1917</span><span class="o">)</span><span class="w">   </span>avg_abs:<span class="w"> </span><span class="m">605</span>.306
bit<span class="o">(</span><span class="m">0</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>LSB<span class="o">)</span>:2<span class="w">    </span>range:<span class="w">  </span><span class="o">(</span>-3229,<span class="w"> </span><span class="m">2113</span><span class="o">)</span><span class="w">   </span>avg_abs:<span class="w"> </span><span class="m">636</span>.341
bit<span class="o">(</span><span class="m">0</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>LSB<span class="o">)</span>:3<span class="w">    </span>range:<span class="w">  </span><span class="o">(</span>-3206,<span class="w"> </span><span class="m">2102</span><span class="o">)</span><span class="w">   </span>avg_abs:<span class="w"> </span><span class="m">611</span>.838
bit<span class="o">(</span><span class="m">0</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>LSB<span class="o">)</span>:4<span class="w">    </span>range:<span class="w">  </span><span class="o">(</span>-2951,<span class="w"> </span><span class="m">2293</span><span class="o">)</span><span class="w">   </span>avg_abs:<span class="w"> </span><span class="m">473</span>.107
bit<span class="o">(</span><span class="m">0</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>LSB<span class="o">)</span>:5<span class="w">    </span>range:<span class="w">  </span><span class="o">(</span>-1360,<span class="w"> </span><span class="m">1182</span><span class="o">)</span><span class="w">   </span>avg_abs:<span class="w"> </span><span class="m">119</span>.271
bit<span class="o">(</span><span class="m">0</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>LSB<span class="o">)</span>:6<span class="w">    </span>range:<span class="w">  </span><span class="o">(</span>-609,<span class="w"> </span><span class="m">737</span><span class="o">)</span><span class="w">     </span>avg_abs:<span class="w"> </span><span class="m">15</span>.876
bit<span class="o">(</span><span class="m">0</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>LSB<span class="o">)</span>:7<span class="w">    </span>range:<span class="w">  </span><span class="o">(</span><span class="m">0</span>,<span class="w"> </span><span class="m">0</span><span class="o">)</span><span class="w">          </span>avg_abs:<span class="w"> </span><span class="m">0</span>.0
</pre></div>
</div>
</section>
<section id="ivc">
<h4>根据统计结果设置IVC系数<a class="headerlink" href="#ivc" title="此标题的永久链接"></a></h4>
<p>根据MAC结果范围设置合理的IVCF, 比如对于上述报告, 根据经验IVCF可以设置为 2500/128-3500/128 (默认ADC是8bit, 考虑正负).</p>
<div class="admonition attention">
<p class="admonition-title">注意</p>
<p>目前为了便于配置, 所有Tile的所有BL都共用同一个IVCF, 之后的版本中会考虑实现逐Tile或逐BL的IVCF细粒度配置.</p>
</div>
</section>
<section id="id6">
<h4>执行仿真<a class="headerlink" href="#id6" title="此标题的永久链接"></a></h4>
<p>设置好了IVCF系数, 就可以正式开始量化后仿真了, 与量化前仿真类似, 如下:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 代码接上回</span>
<span class="o">...</span>

<span class="c1"># 获取量化后的模型参数</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">read_quantparams</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;mapname&#39;</span><span class="p">])</span>

<span class="c1"># 创建CalcuSim仿真器, tm是TileMapper, oc是OnnxConverter</span>
<span class="n">csim</span> <span class="o">=</span> <span class="n">CalcuSim</span><span class="p">(</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">ctg</span><span class="p">,</span> <span class="n">oc</span><span class="o">.</span><span class="n">host_graph</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
    <span class="n">quantize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">physical</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># 获取输入图片数据, 缩放至 224 × 224</span>
<span class="nb">input</span> <span class="o">=</span> <span class="n">get_input</span><span class="p">(</span><span class="s1">&#39;path/to/your/image.png&#39;</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">))</span>

<span class="c1"># 运行CalcuSim仿真, 获得输出结果</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">csim</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

<span class="c1"># 仿真结果验证</span>
<span class="o">...</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="id7">
<h2>中间结果观测<a class="headerlink" href="#id7" title="此标题的永久链接"></a></h2>
<section id="id8">
<h3>中间结果保存<a class="headerlink" href="#id8" title="此标题的永久链接"></a></h3>
<p>为了观测每个Tile的中间结果, 可以在创建 <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 时设置关键字参数 <code class="xref py py-data docutils literal notranslate"><span class="pre">observe</span></code> 为 <cite>True</cite>. 之后运行仿真, 并调用 <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim.save_results</span></code> 方法, 中间结果会被保存至 <cite>./mapsave/your-mapname/calcusim</cite> 目录中, 如下:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 代码接上回</span>
<span class="o">...</span>

<span class="c1"># 获取量化后的模型参数</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">read_quantparams</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;mapname&#39;</span><span class="p">])</span>

<span class="c1"># 创建CalcuSim仿真器, tm是TileMapper, oc是OnnxConverter</span>
<span class="n">csim</span> <span class="o">=</span> <span class="n">CalcuSim</span><span class="p">(</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">ctg</span><span class="p">,</span> <span class="n">oc</span><span class="o">.</span><span class="n">host_graph</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
    <span class="n">quantize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">physical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">observe</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># 获取输入图片数据, 缩放至 224 × 224</span>
<span class="nb">input</span> <span class="o">=</span> <span class="n">get_input</span><span class="p">(</span><span class="s1">&#39;path/to/your/image.png&#39;</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">))</span>

<span class="c1"># 运行CalcuSim仿真, 获得输出结果</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">csim</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

<span class="c1"># 保存中间结果</span>
<span class="n">csim</span><span class="o">.</span><span class="n">save_results</span><span class="p">(</span><span class="s1">&#39;your-filename&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id9">
<h3>中间结果读取<a class="headerlink" href="#id9" title="此标题的永久链接"></a></h3>
<p>可以使用 Maptools 提供的 <code class="xref py py-data docutils literal notranslate"><span class="pre">read_results</span></code> 函数读取保存的中间结果文件, 得到的是一个字典, 其 <cite>key</cite> 是 <a class="reference internal" href="../Maptools%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/core.html#LogicalTile" title="LogicalTile"><code class="xref py py-data docutils literal notranslate"><span class="pre">LogicalTile</span></code></a> 格式的逻辑Tile, <cite>value</cite> 是该Tile的中间结果字典, 建议用户自行查看该字典的结构并获取目标中间结果, 如下:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">maptools</span> <span class="kn">import</span> <span class="n">read_results</span>

<span class="c1"># 读取保存的中间结果</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">read_results</span><span class="p">(</span><span class="s1">&#39;your-mapname&#39;</span><span class="p">,</span> <span class="s1">&#39;your-filename&#39;</span><span class="p">)</span>

<span class="c1"># 查看中间结果字典的结构</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">res</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<span class="c1"># 打印出 (0,0,0,0) 这个逻辑Tile的cast输入数据</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)][</span><span class="s1">&#39;cast_in&#39;</span><span class="p">])</span>
</pre></div>
</div>
</section>
</section>
<section id="id10">
<h2>使用测试集实现准确率评估<a class="headerlink" href="#id10" title="此标题的永久链接"></a></h2>
<p>单张的图片推理只能测试存算一体AI芯片在单一数据上的计算精确度, 而为了获得存算一体AI芯片的识别准确率, 需要使用测试数据集进行测试统计.</p>
<p>下面以一个示例展示了如何使用 <code class="xref py py-data docutils literal notranslate"><span class="pre">CalcuSim</span></code> 统计 <cite>ResNet18</cite> 模型在 <cite>ImageNet</cite> 测试集上的准确率:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">onnx</span>
<span class="kn">import</span> <span class="nn">torchvision</span> <span class="k">as</span> <span class="nn">tv</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms</span> <span class="k">as</span> <span class="nn">transforms</span>
<span class="kn">from</span> <span class="nn">torchvision.models</span> <span class="kn">import</span> <span class="n">resnet18</span><span class="p">,</span> <span class="n">resnet50</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">maptools</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">K</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># 准确率指标为 K-ACC</span>
<span class="n">MAPNAME</span> <span class="o">=</span> <span class="s1">&#39;resnet18&#39;</span>
<span class="n">ONNXDIR</span> <span class="o">=</span> <span class="s1">&#39;onnx_models/simp-resnet18.onnx&#39;</span>
<span class="n">QUANTIZE</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># 是否进行量化</span>
<span class="n">DEVICE</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span> <span class="c1"># 是否使用CUDA加速</span>
<span class="n">BATCHSIZE</span> <span class="o">=</span> <span class="mi">32</span> <span class="c1"># Batch 大小</span>
<span class="n">PHYSICAL</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># 是否模拟真实的Xbar和ADC计算</span>
<span class="n">HARDTRANS</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># 是否模拟真实的定点数乘法</span>
<span class="n">IVCF</span> <span class="o">=</span> <span class="mi">4000</span><span class="o">/</span><span class="mi">128</span> <span class="c1"># ADC电流-电压转换系数</span>

<span class="c1">########################## 以下是 CalcuSim 模型 ########################################</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">onnx</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ONNXDIR</span><span class="p">)</span>
<span class="n">oc</span> <span class="o">=</span> <span class="n">OnnxConverter</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">mapname</span><span class="o">=</span><span class="n">MAPNAME</span><span class="p">,</span> <span class="n">quantize</span><span class="o">=</span><span class="n">QUANTIZE</span><span class="p">)</span>
<span class="n">oc</span><span class="o">.</span><span class="n">run_conversion</span><span class="p">()</span>

<span class="n">xm</span> <span class="o">=</span> <span class="n">TileMapper</span><span class="p">(</span>
    <span class="n">oc</span><span class="o">.</span><span class="n">device_graph</span><span class="p">,</span>
    <span class="mi">256</span><span class="p">,</span>
    <span class="mi">256</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">mapname</span><span class="o">=</span><span class="n">MAPNAME</span><span class="p">,</span>
    <span class="n">quantize</span><span class="o">=</span><span class="n">QUANTIZE</span>
<span class="p">)</span>

<span class="n">xm</span><span class="o">.</span><span class="n">run_map</span><span class="p">()</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">read_quantparams</span><span class="p">(</span><span class="n">MAPNAME</span><span class="p">)</span> <span class="k">if</span> <span class="n">QUANTIZE</span> <span class="k">else</span> <span class="n">oc</span><span class="o">.</span><span class="n">params</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">CalcuSim</span><span class="p">(</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">ctg</span><span class="p">,</span>
    <span class="n">oc</span><span class="o">.</span><span class="n">host_graph</span><span class="p">,</span>
    <span class="n">params</span><span class="p">,</span>
    <span class="n">mapname</span><span class="o">=</span><span class="n">MAPNAME</span><span class="p">,</span>
    <span class="n">quantize</span><span class="o">=</span><span class="n">QUANTIZE</span><span class="p">,</span>
    <span class="n">physical</span><span class="o">=</span><span class="n">PHYSICAL</span><span class="p">,</span>
    <span class="n">hardtrans</span><span class="o">=</span><span class="n">HARDTRANS</span><span class="p">,</span>
    <span class="n">ivcf</span><span class="o">=</span><span class="n">IVCF</span>
<span class="p">)</span>
<span class="c1">########################## 以上是 CalcuSim 模型 ########################################</span>


<span class="c1">########################## 以下是 Pytorch 对照模型 ######################################</span>
<span class="c1"># model = resnet18(pretrained=True)</span>
<span class="c1"># model.eval()</span>
<span class="c1">########################## 以上是 Pytorch 对照模型 ######################################</span>


<span class="c1">########################## 以下是 测试集构建 ############################################</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="k">if</span> <span class="n">DEVICE</span> <span class="o">==</span> <span class="s1">&#39;cuda&#39;</span><span class="p">:</span>
    <span class="n">model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

<span class="n">trans</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">([</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">]),</span>
    <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
    <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span> <span class="n">std</span><span class="o">=</span><span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">))</span>
<span class="p">])</span>

<span class="n">testset</span> <span class="o">=</span> <span class="n">tv</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">ImageFolder</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="s1">&#39;/your/path/to/imagenet-dataset/val&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>

<span class="n">test_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">testset</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCHSIZE</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
<span class="c1">########################## 以上是 测试集构建 ############################################</span>


<span class="c1">########################## 以下是 测试程序 ##############################################</span>
<span class="n">loader_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="p">)</span>

<span class="n">total_samples</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">true_samples</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">get_true_number</span><span class="p">(</span><span class="n">outputs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">preds</span> <span class="o">=</span> <span class="p">[</span><span class="n">output</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">]</span>
    <span class="n">lst</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">preds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))]</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_loader</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Evaluating batches: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">loader_len</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">inputs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">labels</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="n">total_samples</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">true_samples</span> <span class="o">+=</span> <span class="n">get_true_number</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">total samples:&quot;</span><span class="p">,</span> <span class="n">total_samples</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;true samples:&quot;</span><span class="p">,</span> <span class="n">true_samples</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;accuracy:</span><span class="si">%f%%</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">true_samples</span> <span class="o">/</span> <span class="n">total_samples</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
<span class="c1">########################## 以上是 测试程序 ##############################################</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="%E6%98%A0%E5%B0%84%E5%89%8D%E4%BB%BF%E7%9C%9F.html" class="btn btn-neutral float-left" title="映射前仿真" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="TokSim%E4%BB%BF%E7%9C%9F.html" class="btn btn-neutral float-right" title="TokSim仿真" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2023, Wenxu Cao.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>